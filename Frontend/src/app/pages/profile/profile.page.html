<ion-header>
  <ion-toolbar>
    <ion-title>Mon profil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ng-container *ngIf="user as u; else loadingUser">

    <!-- Header card -->
    <ion-item lines="none" class="ion-margin-bottom">
      <ion-avatar slot="start">
        <!-- ✅ Use absolute URL + cache busting -->
        <img [src]="avatarSrc(u)" alt="avatar" />
      </ion-avatar>
      <ion-label>
        <h2>{{ u.nom }}</h2>
        <p>{{ u.email }}</p>
        <p>Rôle : {{ u.role }}</p>
      </ion-label>
    </ion-item>

    <!-- ✅ Only one button: Camera/Gallery chooser -->
    <ion-button expand="block" type="button" (click)="changePhoto()">
      <ion-icon slot="start" name="camera"></ion-icon>
      Changer la photo
    </ion-button>

    <!-- Edit form -->
    <ion-list class="ion-margin-top" [formGroup]="form">
      <ion-item>
        <ion-icon slot="start" name="person"></ion-icon>
        <ion-input label="Nom" labelPlacement="stacked" formControlName="nom"></ion-input>
      </ion-item>
      <ion-note color="danger" *ngIf="form.get('nom')?.touched && form.get('nom')?.invalid">
        Nom requis (min 2 caractères).
      </ion-note>

      <ion-item>
        <ion-icon slot="start" name="mail"></ion-icon>
        <ion-input type="email" label="Email" labelPlacement="stacked" formControlName="email"></ion-input>
      </ion-item>
      <ion-note color="danger" *ngIf="form.get('email')?.touched && form.get('email')?.invalid">
        Email invalide.
      </ion-note>

      <ion-item>
        <ion-icon slot="start" name="lock-closed"></ion-icon>
        <ion-input
          type="password"
          label="Nouveau mot de passe (optionnel)"
          labelPlacement="stacked"
          formControlName="password"
          placeholder="Laisser vide pour ne pas changer">
        </ion-input>
      </ion-item>

      <!-- Role shown in read-only (control disabled in TS) -->
      <ion-item>
        <ion-input label="Rôle" labelPlacement="stacked" formControlName="role"></ion-input>
      </ion-item>
    </ion-list>

    <ion-button class="ion-margin-top" expand="block" type="button" (click)="save()">
      <ion-icon slot="start" name="save"></ion-icon>
      Enregistrer
    </ion-button>
  </ng-container>

  <ng-template #loadingUser>
    <p>Chargement…</p>
  </ng-template>
</ion-content>
